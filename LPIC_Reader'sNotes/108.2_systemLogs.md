## 108.2 System Logs
__weight 4__


### rsyslogd
- daemon do rsyslog;

### klogd
- daemon que trabalha junto com o rsyslog para registro de logs do kernel;

### /etc/rsyslog.conf
- arquivo de configuração do rsyslog;
- também podem ser inseridas regras para o rsyslog em '/etc/ryslog.d/';
- sessões do arquivo:
	- MODULES: suporte modular para registro de eventos, capacidade de mensagem e recepção de log UDP/TCP;
	- GLOBAL DIRECTIVES: configuração de logs e permissões de diretório de logs;
	- RULES: recursos, prioridades e ações, com a sintaxe: ```<facility>.<priority> <action>```;

__Recurso \(facility)__

| número 	| palavra-chave 	| descrição 					|
|-----------|-------------------|-------------------------------|
| 0 		| kern 				| mensagens do kernel 			|
| 1 		| user 				| mensagens de nível do usuário |
| 2 		| mail 				| sistema de email 				|
| 3			| daemon			| daemons do sistema 			|	
| 4			| auth,authpriv		| segurança 					|
| 5			| syslog			| syslogd 						|
| 6			| lpr				| impressora de linha 			|
| 7			| news				| notícia de rede 				|
| 8			| uucp				| Unix-to-Unix Copy Protocol 	|
| 9			| cron				| daemon do relógio 			|
| 10		| auth,authpriv		| segurança 					|
| 11		| ftp				| daemon FTP 					|
| 12		| ntp				| daemon NTP 					|
| 13		| security			| auditoria do log 				|
| 14		| console			| alerta do log 				|
| 15		| cron				| daemon do relógio 			|
| 16-23		| local0 - local7	| uso local 0-7 				|

__Prioridades \(priority)__

| número 	| gravidade		 	| palavra-chave 	| descrição 					|
|-----------|-------------------|-------------------|-------------------------------|
| 0 		| emergência		| emerg, panic		| sistema inutilizável 			|
| 1 		| alerta			| alert				| agir imediatamente			|
| 2 		| crítico			| crit 				| condição crítica				|
| 3			| erro				| err, error		| condição de erro				|	
| 4			| aviso				| warn, warning		| condição de aviso				|
| 5			| atenção			| notice			| normal, mas com importância	|
| 6			| informativo		| info				| mensagem informativa 			|
| 7			| debug				| debug				| mensagem de depuração			|

__Ação \(action)__
- é o campo em que se descreve para onde enviar a mensagem de log;

__EXEMPLOS:__
- ```auth,authpriv.*			/var/log/auth.log```: independente da prioridade '*', todas as mensagens dos recursos 'auth' ou 'authpriv' serão gravadas em '/var/log/auth.log';
- ```*.*;auth,authpriv.none		-/var/log/syslog```: todos os recursos, exceto 'auth,authpriv', como sinaliza '.none', serão gravados em '/var/log/syslog'; '-' antes do caminho evita gravações excessivas; ';' divide o seletor e ',' concatena os recursos;
- ```mail.err			 /var/log/mail.err```: as mensagens de 'mail' com prioridade 'err' ou superior serão enviadas para '/var/log/mail.err';
 
 ```
*.=debug;\
		auth,authpriv.none;\
	news.none;mail.none		-/var/log/debug
 ```

as mensagens 'debug' e nenhuma outra '=' serão gravadas em '/var/log/debug', exceto se vierem  dos recursos 'auth,authpriv', 'news' e 'mail'.

### /var/log/
- diretório onde se encontram logs de sistema, de serviços e de programas;
	- '/var/log/auth.log' arquivo de logs de processos de autenticação, cron jobs etc.;
	- '/var/log/syslog' logs centralizados do rsyslog;
	- '/var/log/debug' depuração de programas;
	- '/var/log/kern.log' mensagens do kernel;
	- '/var/log/messages' mensagens informativas de serviços e de servidor de log centralizado;
	- '/var/log/mail.log' servidor de email, feito postfix;
	- '/var/log/Xorg.0.log' placa de vídeo;
	- '/var/run/utmp' e '/var/log/wtmp' logins bem sucedidos;
	- '/var/log/btmp' logins mal sucedidos, como ataques de força bruta via SSH;
	- '/var/log/faillog' tentativas de autenticação mal sucedidas;
	- '/var/log/lastlog' data e hora de logins de usuário;
	- '/var/log/cups/' diretório para logs do CUPS: error_log, page_lot e access_log;
	- '/var/log/apache2/' ou '/var/log/httpd/' logs do Apache:  access.log, error_log e other_vhosts_access.log;
	- '/var/log/mysql/' logs do MySQL: error_log, mysql.log e mysql-slow.log;
	- '/var/log/samba/' logs do protocolo Session Message Block \(SMB): log., log.nmbd and log.smbd;
	- '/var/log/dpkg.log' logs do dpkg;

- o conteúdo dos logs segue a sintaxe:
	- data/hora;
	- nome do host de origem da mensagem;
	- nome do programa ou do serviço;
	- PID do programa;
	- descrição da ação.

### zless and zmore
- utilitários equivalentes a less e more para a leitura de logs compactados com gzip, função exercida por logrotate;

### who or w
- permite ver logs do binário '/var/log/wtmp'; ver 110.1;

### last -f
- permite ver logs do binário '/var/log/btmp'; ver 110.1;

### faillog -a | less
- permite ver logs do binário '/var/log/faillog';

### lastlog | less
- permite ver logs do binário '/var/log/lastlog';

### Special Log Files
- /dev/log;
- /dev/kmsg.

### logger
- comando que gera mensagem de log, util para testes e scripts;
- a opção '-p' permite definir o recurso \(facility) e a prioridade;
- a opção '-t' permite inserir uma tag;
- tanto a mensagem quanto a tag são passadas entre aspas.

### logrotate
- utilitário responsável pela rotação de log, que é o gerenciamento de ações como mover para novos nomes, arquivar, compactar e enviar por e-mail arquivos de log;
- ele é executado diariamente como um cron job por meio do script '__/etc/cron.daily/logrotate__';
- '__/etc/logrotate.conf__' é o arquivo de configuração, cujos comentários apresentam explicações das finalidades das opções globais, entre as quais consta a inclusão dos arquivos de configuração extras em: 
- '__/etc/logrotate.d__' é o diretório onde se incluem arquivos extras de configuração com as linhas:
	- 'rotate N' preserva N semanas de logs;
	- 'weekly' rotaciona arquivos de log semanalmente;
	- 'missingok' não emite mensagem de erro se o arquivos de log estiver ausente, passando para o seguinte;
	- 'notifyempty' não rotaciona o log se estiver vazio;
	- 'compress' compacta arquivos de log com gzip;
	- 'delaycompress' adia compactação para o próximo ciclo;
	- 'sharedscripts' evita que um script seja executado várias vezes;
	- 'postrotate' indica o início de um script postrotate;
	- 'endrotate' indica o final do script postrotate.

### dmesg
- comando que exibe o buffer de anel do kernel: uma estrutura de dados de tamanho fixo que dispensa mensagens mais antigas conforme novas vão sendo armazenadas.

### systemd-journald.service
- serviço systemd que trabalha como um daemon cuja função é receber informações de log de diversas fontes, mantendo um diário delas;
- '__/etc/systemd/journald.conf__' é o seu arquivo de configuração junto com arquivos '*.conf' em 'journal.conf.d/':
	- __opções de armazenamento de logs:__
		- Storage=volatile logs apenas na memória, com diretório '/run/log/journal/';
		- Storage=persistent logs no disco, no diretório '/var/log/journal/';
		- Storage=auto semelhante ao anterior, mas sem a criação de '/var/log/journal/';
		- Storage=none logs descartados, mas ainda acessíveis por destinos como o console, o anel do kernel ou um socket syslog;
	- __opções de uso de disco:__
		- SystemMaxUse=, RuntimeMaxUse= para definir valores de uso máximo pelo registro persistente e volátil, respectivamente; o padrão é 10% da do espaço;
		- SystemKeepFree=, RuntimeKeepFree= para definir o espaço que deve ser deixado livre; padrão 15%;
		- SystemMaxFileSize=, RuntimeMaxFileSize= definem o tamanho máximo dos arquivos; padrão 1/8 de MaxUse;
		- SystemMaxFiles=, RuntimeMaxFiles= definem o número máximo de arquivos; padrão 100;

- para valer eventuais alterações: ```# systemctl restart systemd-journald```.

### journalctl
- utilitário que exibe os registros de log gerados pelo 'systemd-journald', os quais são armazenados em diários binários;
- __opções:__
	- '-r' exibe as mensagens em ordem reversa;
	- '-f' retorna as mensagens mais recentes enquanto estiver em execução, equivalente a 'tail -f';
	- '-e' salta para o final do diário;
	- '-n N' e '--lines=N' exibem as N linhas mais recentes, sendo 10 o padrão quando não fornecido valor;
	- '-k' e '--dmesg' exibem mensagens do anel do kernel, equivalente a dmesg;
	- '-p' filtra por prioridade ou gravidade;
	- '-b -N' ou '--boot -N' filtram por inicializações anteriores fornecidas em '-N'; sem fornecer '-N' retornam o boot atual;
	- '--list-boots' lista inicializações registradas, com o número da inicialização \(0 para a atual e -1, -2, -3 etc. para anteriores), respectivos IDs e marcas de tempo;
	- '--since' e '--until' permitem fornecer um intervalo de tempo, que pode ser dado por expressões numéricas ou palavras-chave como 'yesterday', 'today', 'tomorrow', 'now';
	- '-u' filtra por unidade fornecida;
- pode-se filtrar o resultado por um programa passando seu caminho absoluto;
- por campo específico:
	- _PRIORITY= seguido de um dos 8 valores possíveis de syslog;
	- _SYSLOG_FACILITY= valores de código de recurso;
	- _PID= por PID de processo;
	- _BOOT_ID= ID de inicialização;
	- _TRANSPORT= transporte específico, como journal, syslog, stdout, kernel etc.;
- pode-se verificar o uso de disco pelo armazenamento de logs com a opção '--disk-usage'.

### systemd-cat
- equivalente systemd ao logger, normalmente concatenado com echo;
- ```$ systemd-cat -p emerg echo "This is not a real emergency."```.