## 101.3 Runlevels
__weight 3__


### SysVinit levels:
- __0__
	- encerramento do sistema;
- __1, s, single__
	- modo de usuário único \(single user), sem rede e outros recursos não essenciais \(modo de manutenção);
- __2, 3, 4__
	- modo multiusuário, em que os usuários podem se logar via console ou rede; os níveis 2 e 4 não são usados com muita frequência, mas costumam representar:
	- __2__ modo multiusuário sem rede, diferente do '3', com rede;
	- __4__ reservado para uso pessoal;
- __5__
	- equivale ao nível 3, com login em modo gráfico;
- __6__
	- reinicialização do sistema.

- caso necessário, o level desejado é passado ao init no GRUB através do parâmetro:
	- ```init=/sbin/init level```, em que 'level' é o número correspondente.

### 'init' and 'telinit' commands:
- o init é o primeiro programa a ser executado, recebendo PID 1;
- o init identifica o nível de execução fornecido como parâmetro do kernel ou definido no arquivo '/etc/inittab';
- __opções:__
	- 'q' ou 'Q' uma vez utilizada, carrega novas configurações quando o '/etc/inittab' é modificado;
	- mais opções abaixo, em 'Shutdown and Restart'.

### '/etc/inittab' file
- sintaxe do arquivo: __id:runlevels:action:process__
- __actions:__
	- boot: processo executado durante inicialização;
	- bootwait: processos cuja conclusão será aguardada pelo init;
	- sysinit: processo executado após inicialização;
	- wait: processo no runlevel data, cuja conclusão será aguardada pelo init;
	- respawn: processo será reiniciado caso encerrado;
	- ctrlaltdel: processo será executado quando o init receber o sinal SIGINIT, disparado pelo acionamento das teclas.

### 'runlevel' command
- exibe o nível anterior e o que está ativo: 
	- ex.: 's 2' \(single user e lvl 2); caso o atual seja o primeiro, no espaço do anterior aparece a letra 'N'.

### '/etc/rc2.d/' directories
- diretórios onde se encontram links symlinks para os scripts dos serviços correspondentes aos níveis;
- o nome do diretório segue o padrão 'rcN.d', em que 'N' é o número que representa o nível que corresponde a cada diretório;
- os symlinks possuem o seguinte padrão de nomeação: 'XNname', em que 'X' pode ser 'K', para 'kill', ou 'S', para 'start'. 'N' será um número de prioridade na ordem de realização de 'K' ou 'S', sendo o menor número a prioridade maior.

	
## Systemd units


### service
- tipo mais comum, para recursos ativos no sistema que podem ser iniciados, interrompidos e recarregados.

### socket
- pode ser socket de sistema de arquivos ou socket de rede; cada unidade socket tem uma unidade service correspondente.

### device
- unidade relacionada a um dispositivo de hardware identificado pelo kernel.

### mount
- unidade responsável pelo ponto de montagem do sistema de arquivos.

### automount
- unidade de montagem automática.

### target
- unidade de destino que é um agrupamento de outras unidades gerenciadas como uma única unidade.
	- __graphical.target__: inicia os serviços do sistema e a sessão gráfica; ela ativa a unidade 'multi-user.target';
	- __multi-user.target__: inicia os serviços do sistema essenciais ou não, mas não carrega a interface gráfica;
	- __rescue.target__: recuperação do sistema, que tenta montar todos os sistemas de arquivos e iniciar serviços importantes para o sistema, mas não ativa interfaces de rede e impede que usuários façam logon ao mesmo tempo.

### snapshot
- estado salvo do gerenciador do systemd.


## Systemd commands


### systemctl start unit.service
- inicia uma unit.

### systemctl stop unit.service
- interrompe uma unit.

### systemctl restart unit.service
- reinicia uma unit.

### systemctl list-unit-files 
- lista todas as units disponíveis e seus status, exibindo dados extraídos do diretório '/lib/systemd/system/';
- pode-se usar a opção '--type=service' ou qualquer outro tipo para filtrar os resultados por ele.

### systemctl status unit.service
- exibe o status de uma unit.

### systemctl is-active unit.service
- retorna se uma unit está ou não ativa.

### systemctl enable unit.service
- habilita uma unit a ser carregada durante a inicialização do sistema.

### systemctl disable unit.service
- desabilita o carregamento de uma unit com o sistema.

### systemctl is-enabled unit.service
- verifica se uma unit é iniciada com o sistema.

### systemctl isolate multi-user.target
- alterna manualmente o target do sistema para o target 'multi-user.target'.

### systemctl set-default graphical.target
- configura o target padrão como 'multi-user.target', alterando o symlink '/etc/systemd/system/default.target'.

### systemctl get-default
- retorna o modo em execução.


## Shutdown and Restart


### shutdown *options time message*
- comando que envia os sinais SIGTERM e SIGKILL a todos os processos;
- quando as opções '-h' e '-r' não são usadas, o sistema alterna para o nível 1 de execução;
- o parâmetro 'time' é obrigatório e recebe valores como hora exata para desligamento no formato 'hh:mm', '+m', em que 'm' é o valor em minutos, ou ainda 'now' ou '0', para desligamento imediato;
- __opções:__
	- '-h' encerra o sistema;
	- '-r' reinicia o sistema;
	- '-F' força a checagem do sistema de arquivos durante o boot;
	- '-c' cancela uma programação de shutdown configurada;
	- incluir '-a' na linha do comando ctrlaltdel do arquivo '/etc/inittab' restringe em sistemas SysVinit os usuários que podem usar o recurso a apenas usuários listados no arquivo '/etc/shutdown.allow'.

### wall
- comando exclusivo de super-usuários que exibe uma mensagem para todos os usuários logados durante o desligamento, com a sintaxe:
	- ```# wall <<<"message"``` ou
	- ```# wall /path/to/file/to/show```

### shutdown and reboot equivalents

- shutdown = poweroff = halt = systemctl poweroff = init 0 = telinit 0
- shutdown -r = reboot = systemctl reboot = init 6 = telinit 6

