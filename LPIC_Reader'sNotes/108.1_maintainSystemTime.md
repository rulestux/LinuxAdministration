## 108.1 Maintain System Time
__weight 3__


### date
- comando que exibe a hora e a data do sistema, além do fuso horário atual;
- __opções:__
	- '-u' exibe o horário UTC;
	- '-s' altera a data e a hora, como exemplificado abaixo;
	- '-I' formato ISO 8601; pode-se anexar '-Idate', '-Ihours', '-Iminutes', '-Iseconds' ou '-Ins' para refinar o resultado;
	- '-R' formato RFC 5322;
	- '--rfc-3339' formato RFC 3339;
	- '+%s' tempo do Unix, em segundos desde 01/01/1970;
	- '--date='@1564013011'' aplica data com o tempo do Unix;
	- '--debug' seguido de uma data válida, permite solucionar problemas em aplicativos que geram datas;
- definir hora e data com date: 

	- ```# date --set="11 Nov 2011 11:11:11"``` ou 

	- ```# date +%Y%m%d -s "20111125"```, para data, e 

	- ```# date +%T -s "13:11:00"```, para hora.

### hwclock
- exibe a hora do relógio do hardware;
- a opção '--verbose' mostra em detalhes;
	- o campo ```Calculated Hardware Clock drift``` informa o sincronismo entre hora de sistema e hora do hardware;
- ```# hwclock --set --date "4/12/2019 11:15:19"``` ajusta o relógio do hardware;
- ```# hwclock --hctosys``` ou '-s' ajusta o relógio do sistema a partir do relógio do hardware;
- ```# hwclock --systohc```,  ou '-w', para sincronizar o relógio do hardware a partir do relógio do sistema.

### timedatectl
- comando systemd que exibe mais detalhes a respeito de hora, data e fuso horário;
- o campo 'RTC time' exibe a hora do relógio do hardware;
	- 'timedatectl set-time 'AAAA-MM-DD HH:MM:SS'' ajusta a hora, como comando preferencial com systemd;
	- 'timedatectl set-ntp no' desativa o NTP: __Network Time Protocol__, hora da rede;
 	- 'timedatectl list-timezones' lista timezones disponíveis;
	- 'timedatectl set-timezone TIME/ZONE' redefine o link simbólico '/etc/localtime', que aponta para dados em '/usr/share/zoneinfo/'.

### /usr/share/zoneinfo/
- diretório que contém informações sobre diferentes fusos horários possíveis;
- a estrutura de subdiretórios e arquivos em '__/usr/share/zoneinfo/__', segue:
	- __/usr/share/zoneinfo/REGION/LOCALE__
- para definir um fuso horário, cria-se um link simbólico em '/etc/localtime', como no exemplo:
 ```$ ln -s /usr/share/zoneinfo/Canada/Eastern /etc/localtime```
 ```# hwclock --systohc```, para sincronizar o relógio do hardware a partir do relógio do sistema;
- o symlink '/etc/timezone' se define da mesma maneira que '/etc/localtime'.

### ntpd
- daemon consumidor que verifica a hora de provedor NTP regularmente;
- o ntpd também pode ser um provedor NTP para outras máquinas, que custumam ter apenas um cliente SNTP, em vez de uma implementação NTP completa;
	- verificar status de cliente SNTP: ```$ systemctl status systemd-timesyncd```;
	- verificar status de sincronização de cliente SNTP: ```$ timedatectl show-timesync --all```;
	- verificar status de sistema NTPD: ```$ systemctl status ntpd```;
	- habilitar NTPD: ```# systemctl enable ntpd && systemctl start ntpd```.

### /etc/ntp.conf
- arquivo que contém a configuração do sistema de sincronia NTP;
- sintaxe para adicionar servidores:
 ```
server (IP Address)
server server.url.localhost
 ```
- os servidores costumam ser configurados como 'pool.ntp.org'

### ntpq
- utilitário para monitorar o status NTP do daemon ntpd;
- 'ntpq -p' exibe um resumo do status, com os seguintes campos:
	- remote: host do provedor NTP;
	- refid: ID de referência do provedor;
	- st: estrato do provedor;
	- when: número em segundos desde a última consulta;
	- poll: número em segundos entre as consultas;
	- reach: ID de status das conexões, sendo acrescido 1 a cada conexão bem sucedida;
	- delay: tempo em ms entre a consulta e a resposta do provedor;
	- offset: tempo em ms entre a hora do sistema e a hora NTP;
	- jitter: deslocamento em ms entre a hora do sistema e o NTP na última consulta;
- sem opções e argumentos, o ntpq entra em modo interativo; '?' é uma opção de ajuda para ver os comandos do ntpq.

### ntpdate
- cliente NTP que atualiza a data e hora do sistema.

### chrony
- chrony é a ferramenta que ativa o deamon chronyd, outra forma de implementar o NTP, cuja interface CLI é o __chronyc__;
- 'chrony tracking' é o comando que exibe informações sobre o NTP e a hora do sistema:
	- Reference ID: ID de referência do provedor;
	- Stratum: estrato do provedor;
	- Ref time: hora UTC da última medição;
	- System time: atraso do relógio do sistema do provedor;
	- Last offset: deslocamento estimado da última atualização;
	- RMS offset: média de longo prazo do valor do deslocamento;
	- Frequency: taxa em ppm \(partes por milhão) de erro do sistema caso o chronyd não estivesse corrigindo;
	- Residual freq: frequência residual da diferença entre as medições do provedor e a frequência em uso;
	- Skew: limite de erro estimado da frequência;
	- Root delay: total de atrasos do caminho de rede até o estrato do provedor;
	- Leap status: status de intercalação, que pode ser normal, inserir segundo, excluir segundo ou não sincronizado.
- 'chrony ntpdata' traz outros detalhes sobre a conexão;
- 'chronyc sources' retorna informações sobre servidores NTP usados;
- 'chronyc makestep' realiza a atualização manual do NTP com chrony.

### /etc/chrony.conf
- arquivo de configuração do chrony, em que as fontes podem ser adicionadas;
- servidores listados com um '!' na frente estão comentados;
- ao se fazer ajustes, reiniciar o serviço com 'chronyd' e ajustar o relógio do sistema com ```# chronyc makestep```.
